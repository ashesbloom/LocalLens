name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # macOS Build (Apple Silicon)
  # ============================================================================
  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies (Homebrew)
        run: |
          brew install cmake dlib imagemagick

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Create Python virtual environment
        run: |
          cd backend
          python -m venv .venv

      - name: Install backend requirements
        run: |
          cd backend
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pyinstaller==6.11.1

      - name: Build Python backend with PyInstaller
        run: |
          cd backend
          source .venv/bin/activate
          python -m PyInstaller backend_server.spec

      - name: Install frontend requirements
        run: |
          cd frontend
          npm install

      - name: Copy backend bundle for Tauri
        run: |
          cd frontend
          node ensure-backend.js

      - name: Build Tauri application
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
        run: |
          cd frontend
          npm run tauri build

      - name: Find macOS build artifacts
        id: find_files
        run: |
          cd frontend/src-tauri/target/release/bundle
          
          # Find the DMG file
          DMG_FILE=$(find dmg -name "*.dmg" 2>/dev/null | head -1)
          if [ -n "$DMG_FILE" ]; then
            DMG_PATH="$(pwd)/$DMG_FILE"
            DMG_NAME=$(basename "$DMG_FILE")
            echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT
            echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
            echo "Found DMG: $DMG_PATH"
          fi
          
          # Find the .app.tar.gz file (for updater)
          TARBALL=$(find macos -name "*.app.tar.gz" 2>/dev/null | head -1)
          if [ -n "$TARBALL" ]; then
            TARBALL_PATH="$(pwd)/$TARBALL"
            TARBALL_NAME=$(basename "$TARBALL")
            echo "tarball_path=$TARBALL_PATH" >> $GITHUB_OUTPUT
            echo "tarball_name=$TARBALL_NAME" >> $GITHUB_OUTPUT
            echo "Found tarball: $TARBALL_PATH"
          fi
          
          # Find the signature file
          SIG_FILE=$(find macos -name "*.app.tar.gz.sig" 2>/dev/null | head -1)
          if [ -n "$SIG_FILE" ]; then
            SIG_PATH="$(pwd)/$SIG_FILE"
            SIGNATURE=$(cat "$SIG_PATH")
            echo "sig_path=$SIG_PATH" >> $GITHUB_OUTPUT
            echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
            echo "Found signature: $SIG_PATH"
          fi

      - name: Generate macOS checksums
        run: |
          cd frontend/src-tauri/target/release/bundle
          
          # Generate checksums for DMG (in dmg folder so artifact upload finds it)
          if [ -f "${{ steps.find_files.outputs.dmg_path }}" ]; then
            shasum -a 256 "${{ steps.find_files.outputs.dmg_path }}" | awk '{print $1 "  " FILENAME}' FILENAME="${{ steps.find_files.outputs.dmg_name }}" > dmg/checksums-macos.txt
            echo "Generated checksums:"
            cat dmg/checksums-macos.txt
          else
            echo "No DMG found for checksums"
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            frontend/src-tauri/target/release/bundle/dmg/*.dmg
            frontend/src-tauri/target/release/bundle/dmg/checksums-macos.txt
            frontend/src-tauri/target/release/bundle/macos/*.app.tar.gz
            frontend/src-tauri/target/release/bundle/macos/*.app.tar.gz.sig
          retention-days: 5

  # ============================================================================
  # Windows Build
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Backend: Create virtual environment and install requirements
      - name: Create Python virtual environment
        run: |
          cd backend
          python -m venv venv

      - name: Activate venv and install backend requirements
        run: |
          cd backend
          .\venv\Scripts\activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # Backend: Build with PyInstaller using your spec file
      - name: Build Python backend with PyInstaller
        run: |
          cd backend
          .\venv\Scripts\activate
          python -m PyInstaller backend_server.spec

      # Frontend: Install requirements in src-tauri folder
      - name: Install frontend requirements
        run: |
          cd frontend
          npm install

      # Run ensure-backend.js to copy and rename the backend executable
      - name: Copy and rename backend executable
        run: |
          cd frontend
          node ensure-backend.js

      - name: Install Tauri requirements
        run: |
          cd frontend/src-tauri
          # Install any additional Tauri-specific requirements if needed
          # Currently using npm install from frontend folder covers this

     
      # Build the final application
      - name: Build Tauri application
        env:
          # Pass the Base64 secret DIRECTLY here. 
          # Tauri will handle the decoding automatically.
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''

        run: |
          cd frontend
          npm run tauri build



      # Generate checksums for verification
      - name: Generate checksums
        run: |
          cd frontend\src-tauri\target\release\bundle
          $files = Get-ChildItem -Recurse -Include "*.msi", "*.exe" | Where-Object { $_.Directory.Name -eq "msi" -or $_.Directory.Name -eq "nsis" }
          $checksums = @()
          foreach ($file in $files) {
            $hash = Get-FileHash -Path $file.FullName -Algorithm SHA256
            $checksums += "$($hash.Hash.ToLower())  $($file.Name)"
          }
          $checksums | Out-File -FilePath "checksums-windows.txt" -Encoding utf8
          Write-Output "Generated checksums:"
          Get-Content "checksums-windows.txt"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            frontend/src-tauri/target/release/bundle/msi/*.msi
            frontend/src-tauri/target/release/bundle/msi/*.msi.sig
            frontend/src-tauri/target/release/bundle/nsis/*.exe
            frontend/src-tauri/target/release/bundle/nsis/*.exe.sig
            frontend/src-tauri/target/release/bundle/checksums-windows.txt
          retention-days: 5

      - name: Build Summary
        run: |
          Write-Output "âœ… Windows build completed successfully!"
          Write-Output "ðŸ“¦ Artifacts uploaded for release job"

  # ============================================================================
  # Create GitHub Release (after both builds complete)
  # ============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: artifacts/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: artifacts/macos

      - name: List downloaded artifacts
        run: |
          echo "=== Windows Artifacts ==="
          find artifacts/windows -type f
          echo ""
          echo "=== macOS Artifacts ==="
          find artifacts/macos -type f

      - name: Get version
        id: get_version
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#v}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Version: $version"

      - name: Extract release notes
        id: release_notes
        run: |
          version="${{ steps.get_version.outputs.version }}"
          changelog_path="CHANGELOG.md"
          
          if [ -f "$changelog_path" ]; then
            # Extract notes for this version
            notes=$(awk "/^## \[$version\]/{flag=1; next} /^## \[/{flag=0} flag" "$changelog_path" | sed '/^$/d')
            if [ -n "$notes" ]; then
              echo "Found release notes for version $version"
              # Use delimiter for multiline output
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "$notes" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "No specific notes found, using default"
              echo "notes=Release $version - See CHANGELOG.md for details" >> $GITHUB_OUTPUT
            fi
          else
            echo "CHANGELOG.md not found, using default notes"
            echo "notes=Release $version" >> $GITHUB_OUTPUT
          fi

      - name: Find artifact files
        id: find_files
        run: |
          # Windows artifacts
          MSI_FILE=$(find artifacts/windows -name "*.msi" ! -name "*.sig" 2>/dev/null | head -1)
          MSI_SIG=$(find artifacts/windows -name "*.msi.sig" 2>/dev/null | head -1)
          EXE_FILE=$(find artifacts/windows -name "*.exe" ! -name "*.sig" 2>/dev/null | head -1)
          CHECKSUMS_WIN=$(find artifacts/windows -name "checksums-windows.txt" 2>/dev/null | head -1)
          
          # macOS artifacts
          DMG_FILE=$(find artifacts/macos -name "*.dmg" 2>/dev/null | head -1)
          TARBALL=$(find artifacts/macos -name "*.app.tar.gz" 2>/dev/null | head -1)
          TARBALL_SIG=$(find artifacts/macos -name "*.app.tar.gz.sig" 2>/dev/null | head -1)
          CHECKSUMS_MAC=$(find artifacts/macos -name "checksums-macos.txt" 2>/dev/null | head -1)
          
          echo "msi_path=$MSI_FILE" >> $GITHUB_OUTPUT
          echo "msi_sig_path=$MSI_SIG" >> $GITHUB_OUTPUT
          echo "exe_path=$EXE_FILE" >> $GITHUB_OUTPUT
          echo "checksums_win_path=$CHECKSUMS_WIN" >> $GITHUB_OUTPUT
          echo "dmg_path=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "tarball_path=$TARBALL" >> $GITHUB_OUTPUT
          echo "tarball_sig_path=$TARBALL_SIG" >> $GITHUB_OUTPUT
          echo "checksums_mac_path=$CHECKSUMS_MAC" >> $GITHUB_OUTPUT
          
          # Read signatures for latest.json
          if [ -n "$MSI_SIG" ] && [ -f "$MSI_SIG" ]; then
            WIN_SIG=$(cat "$MSI_SIG")
            echo "win_signature=$WIN_SIG" >> $GITHUB_OUTPUT
          fi
          if [ -n "$TARBALL_SIG" ] && [ -f "$TARBALL_SIG" ]; then
            MAC_SIG=$(cat "$TARBALL_SIG")
            echo "mac_signature=$MAC_SIG" >> $GITHUB_OUTPUT
          fi

      - name: Generate latest.json for Tauri updater
        run: |
          version="${{ steps.get_version.outputs.version }}"
          tag="${{ github.ref_name }}"
          repo="${{ github.repository }}"
          pub_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          win_sig="${{ steps.find_files.outputs.win_signature }}"
          mac_sig="${{ steps.find_files.outputs.mac_signature }}"
          
          # Generate latest.json using printf to avoid heredoc YAML issues
          printf '{\n  "version": "%s",\n  "notes": "See release notes on GitHub",\n  "pub_date": "%s",\n  "platforms": {\n    "windows-x86_64": {\n      "signature": "%s",\n      "url": "https://github.com/%s/releases/download/%s/Local_Lens_%s_x64_en-US.msi"\n    },\n    "darwin-aarch64": {\n      "signature": "%s",\n      "url": "https://github.com/%s/releases/download/%s/Local_Lens.app.tar.gz"\n    }\n  }\n}\n' \
            "$version" "$pub_date" "$win_sig" "$repo" "$tag" "$tag" "$mac_sig" "$repo" "$tag" > latest.json
          
          echo "Generated latest.json:"
          cat latest.json

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Local Lens ${{ github.ref_name }}
          draft: true
          prerelease: false
          body: |
            ## Local Lens ${{ github.ref_name }}
            
            ${{ steps.release_notes.outputs.notes }}
            
            ---
            
            ### ðŸ”’ Security & Verification
            
            This release was built automatically using GitHub Actions for Windows and macOS:
            
            - **Source Code**: Available in this repository at tag `${{ github.ref_name }}`
            - **Build Process**: View the complete build log in the [Actions tab](https://github.com/${{ github.repository }}/actions)
            - **Checksums**: SHA256 checksums provided for file verification
            
            ### ðŸ“¥ Downloads
            
            **Windows:**
            - **MSI Installer**: Recommended for enterprise/managed environments
            - **EXE Installer**: Recommended for individual users
            
            **macOS (Apple Silicon):**
            - **DMG**: Drag and drop to Applications folder
            
            ### âœ… File Verification
            
            **Windows:**
            ```cmd
            certutil -hashfile "installer_name" SHA256
            ```
            
            **macOS:**
            ```bash
            shasum -a 256 "Local Lens.dmg"
            ```
            
            ### ðŸš€ Installation
            
            **Windows:**
            1. Download your preferred installer format
            2. Run the installer (Admin recommended for MSI)
            3. Launch Local Lens from Start Menu
            
            **macOS:**
            1. Download the DMG file
            2. Open the DMG and drag Local Lens to Applications
            3. First launch: Right-click â†’ Open (to bypass Gatekeeper)

      # Upload Windows artifacts
      - name: Upload MSI installer
        if: steps.find_files.outputs.msi_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_files.outputs.msi_path }}
          asset_name: Local_Lens_${{ github.ref_name }}_x64_en-US.msi
          asset_content_type: application/x-msi

      - name: Upload EXE installer
        if: steps.find_files.outputs.exe_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_files.outputs.exe_path }}
          asset_name: Local_Lens_${{ github.ref_name }}_x64-setup.exe
          asset_content_type: application/x-msdownload

      - name: Upload Windows checksums
        if: steps.find_files.outputs.checksums_win_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_files.outputs.checksums_win_path }}
          asset_name: checksums-windows.txt
          asset_content_type: text/plain

      # Upload macOS artifacts
      - name: Upload DMG
        if: steps.find_files.outputs.dmg_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_files.outputs.dmg_path }}
          asset_name: Local_Lens_${{ github.ref_name }}_aarch64.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload macOS app tarball (for updater)
        if: steps.find_files.outputs.tarball_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_files.outputs.tarball_path }}
          asset_name: Local_Lens.app.tar.gz
          asset_content_type: application/gzip

      - name: Upload macOS checksums
        if: steps.find_files.outputs.checksums_mac_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_files.outputs.checksums_mac_path }}
          asset_name: checksums-macos.txt
          asset_content_type: text/plain

      # Upload latest.json for Tauri auto-updater
      - name: Upload latest.json
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: latest.json
          asset_name: latest.json
          asset_content_type: application/json

      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸ“¦ Uploaded artifacts:"
          echo "   Windows: MSI, EXE, checksums"
          echo "   macOS: DMG, app tarball, checksums"
          echo "ðŸ“‹ latest.json generated for auto-updater (Windows + macOS)"
          echo "ðŸ”’ Release created as draft - review and publish manually"
